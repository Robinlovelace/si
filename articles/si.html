<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="si">
<title>Spatial interaction models with R • si</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial interaction models with R">
<meta property="og:description" content="si">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">si</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/si.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/validation.html">Validation of spatial interaction models</a>
    <a class="dropdown-item" href="../articles/sims-first-principles.html">An introduction to spatial interaction models: from first principles</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/robinlovelace/si/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="si_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Spatial interaction models with R</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/robinlovelace/si/blob/HEAD/vignettes/si.Rmd" class="external-link"><code>vignettes/si.Rmd</code></a></small>
      <div class="d-none name"><code>si.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>You need to have <a href="https://cran.r-project.org/" class="external-link">installed R</a> and a suitable editor such as <a href="https://www.rstudio.com/products/rstudio/download/preview/" class="external-link">RStudio</a> or <a href="https://github.com/REditorSupport/vscode-R" class="external-link">VSCode with R plugin</a>. See the package’s <a href="https://robinlovelace.github.io/si/">README</a> for instructions on installing the {si} package.</p>
<!--#  Test the necessary packages are installed by loading them (we will also use {dplyr}):-->
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/robinlovelace/si" class="external-link">si</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="input-data">Input data<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h2>
<p>This tutorial builds on a <a href="https://github.com/adamdennett/SIModelling/blob/SIModelling-Edits/SimAus2.Rmd" class="external-link">reproducible</a> guide to SIMs in R <span class="citation">(Dennett 2018)</span>.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt; See &lt;span class="citation"&gt;Dennett (2012)&lt;/span&gt; or an earlier guide on SIMs in R.&lt;/p&gt;'><sup>1</sup></a> We start by importing open access data representing movement between zones in Australia (thanks to Adam Dennett for making the files accessible):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">u1</span> <span class="op">=</span> <span class="st">"https://github.com/Robinlovelace/si/releases/download/0.0.1/zones_aus.geojson"</span>
<span class="va">zones_aus</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">u1</span><span class="op">)</span>
<span class="va">u2</span> <span class="op">=</span> <span class="st">"https://www.dropbox.com/s/wi3zxlq5pff1yda/AusMig2011.csv?raw=1"</span>
<span class="va">od_aus</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">u2</span><span class="op">)</span></code></pre></div>
<p>Let’s take a quick look at and ‘minimize’ these input datasets before modelling them with SIMs:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">zones_aus</span><span class="op">)</span>
<span class="co">#&gt; [1] 15  7</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">zones_aus</span><span class="op">)</span>
<span class="co">#&gt; [1] "GCCSA_CODE" "GCC_CODE16" "GCCSA_NAME" "STATE_CODE" "STATE_NAME"</span>
<span class="co">#&gt; [6] "AREA_SQKM"  "geometry"</span>
<span class="va">key_zone_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GCCSA_CODE"</span>, <span class="st">"GCCSA_NAME"</span>, <span class="st">"AREA_SQKM"</span><span class="op">)</span>
<span class="va">zones</span> <span class="op">=</span> <span class="va">zones_aus</span><span class="op">[</span><span class="va">key_zone_names</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">zones</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 2 features and 3 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 140.9993 ymin: -37.50503 xmax: 153.6298 ymax: -28.16441</span>
<span class="co">#&gt; Geodetic CRS:  GDA94</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span>
<span class="co">#&gt;   GCCSA_CODE GCCSA_NAME     AREA_SQKM                                   geometry</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                         <span style="color: #949494; font-style: italic;">&lt;MULTIPOLYGON [°]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1RNSW      Rest of NSW      <span style="text-decoration: underline;">788</span>443. (((153.008 -28.34026, 153.11 -28.35709, 1…</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1GSYD      Greater Sydney    <span style="text-decoration: underline;">12</span>368. (((151.5961 -33.16168, 151.6305 -33.17709…</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">od_aus</span><span class="op">)</span>
<span class="co">#&gt; [1] 225  13</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">od_aus</span><span class="op">)</span>
<span class="co">#&gt;  [1] "Origin"          "Orig_code"       "Destination"     "Dest_code"      </span>
<span class="co">#&gt;  [5] "Flow"            "vi1_origpop"     "wj1_destpop"     "vi2_origunemp"  </span>
<span class="co">#&gt;  [9] "wj2_destunemp"   "vi3_origmedinc"  "wj3_destmedinc"  "vi4_origpctrent"</span>
<span class="co">#&gt; [13] "wj4_destpctrent"</span>
<span class="va">key_od_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Orig_code"</span>, <span class="st">"Dest_code"</span>, <span class="st">"Flow"</span><span class="op">)</span>
<span class="va">od</span> <span class="op">=</span> <span class="va">od_aus</span><span class="op">[</span><span class="va">key_od_names</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;   Orig_code Dest_code    Flow</span>
<span class="co">#&gt; 1     1GSYD     1GSYD 3395015</span>
<span class="co">#&gt; 2     1GSYD     1RNSW   91031</span></code></pre></div>
<p>The results printed above show that:</p>
<ul>
<li><p><code>zones_aus</code> represents the 15 regions of Australia, with columns containing zone identifiers (IDs), primarily <code>GCCSA_CODE</code>, and the area of each zone (<code>AREA_SQKM</code>). The minimal <code>zones</code> object contains only the region code, name, and area.</p></li>
<li><p><code>od_aus</code> contains 225 rows of data representing the movement of people between the zones in <code>aus</code>. Note that 255 is 15 squared, meaning that this OD dataset contains the complete combination of migration flows, starting with zone <code>1GSYD</code> to <code>1GSYD</code>. These codes are present in the <code>GCCSA_CODE</code> column in the <code>aus</code> object. The first row of the OD dataset represents ‘intra-zonal’ migrations in Greater Sydney, presumably counting the number of people who move house from somewhere in the region to another home in the region. There are 13 columns in this dataset, the most important of which are <code>Orig_code</code>, <code>Dest_code</code>, and <code>Flow</code>, which we have captured in the minimal <code>od</code> dataset.</p></li>
</ul>
<p>Note: a useful convention with ‘long form’ OD datasets is for the first two columns to contain zone IDs that correspond to values in the first column of the zone dataset. The R package <a href="https://itsleeds.github.io/od/" class="external-link">{od}</a>, on which {si} builds, assumes that inputs to its functions are in this form.</p>
<p>It is a good idea to verify that the origin and destination codes in the <code>od</code> dataset match the zone codes in <code>zones</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">od</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    Mode    TRUE </span>
<span class="co">#&gt; logical     225</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">od</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;    Mode    TRUE </span>
<span class="co">#&gt; logical     225</span></code></pre></div>
<p>It is clear from the above that we have ‘clean’ input datasets, let’s begin with the modelling!</p>
</div>
<div class="section level2">
<h2 id="preparing-a-sim">Preparing a SIM<a class="anchor" aria-label="anchor" href="#preparing-a-sim"></a>
</h2>
<p>Key to the workings of the {si} package is the conversion of geographic objects representing origins and destinations into an OD dataset. In this case, we already have an OD dataset, so this step is less relevant. However, we will take this step in any case because many SIMs start without such a comprehensive OD dataset as we have in this case.</p>
<p>Prepare the OD dataset as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_sim</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_to_od.html">si_to_od</a></span><span class="op">(</span>origins <span class="op">=</span> <span class="va">zones</span>, destinations <span class="op">=</span> <span class="va">zones</span><span class="op">)</span>
<span class="co">#&gt; Maximum distance is &gt; 100km. The 'cheap' measure is inaccurate over such</span>
<span class="co">#&gt; large distances, you'd likely be better using a different 'measure'.</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">od_sim</span><span class="op">)</span>
<span class="co">#&gt; [1] "O"                      "D"                      "distance_euclidean"    </span>
<span class="co">#&gt; [4] "origin_GCCSA_NAME"      "origin_AREA_SQKM"       "destination_GCCSA_NAME"</span>
<span class="co">#&gt; [7] "destination_AREA_SQKM"  "geometry"</span></code></pre></div>
<p>Note that the output has duplicate columns: <code><a href="../reference/si_to_od.html">si_to_od()</a></code> joins data from the origin and destination objects into the resulting OD object.</p>
</div>
<div class="section level2">
<h2 id="an-unconstrained-sim">An unconstrained SIM<a class="anchor" aria-label="anchor" href="#an-unconstrained-sim"></a>
</h2>
<p>A simplistic SIM can be created just based on the distance between points:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si_power</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">(</span><span class="va">d</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span><span class="op">^</span><span class="va">beta</span>
<span class="va">od_calculated</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_calculate.html">si_calculate</a></span><span class="op">(</span>
  <span class="va">od_sim</span>,
  fun <span class="op">=</span> <span class="va">si_power</span>,
  d <span class="op">=</span> <span class="va">distance_euclidean</span>,
  beta <span class="op">=</span> <span class="op">-</span><span class="fl">0.8</span>
  <span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">od_calculated</span><span class="op">[</span><span class="st">"interaction"</span><span class="op">]</span>, logz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Warning in classInt::classIntervals(v0, min(nbreaks, n.unq), breaks, warnSmallN</span>
<span class="co">#&gt; = FALSE): var has infinite values, omitted in finding classes</span></code></pre></div>
<p><img src="si_files/figure-html/unconstrained1-1.png" width="700"></p>
<p>This approach, ignoring all variables at the level of trip origins and destinations, results in flow estimates with no units. Before learning how to run constrained SIMs, let’s scale the result by the total flow and see how far we are from reality, just focussing on the interzonal OD pairs:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_interzonal</span> <span class="op">=</span> <span class="va">od</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Orig_code</span> <span class="op">!=</span> <span class="va">Dest_code</span><span class="op">)</span>
<span class="va">od_calculated_interzonal</span> <span class="op">=</span> <span class="va">od_calculated</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">O</span> <span class="op">!=</span> <span class="va">D</span><span class="op">)</span> 
<span class="va">scale_factor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">od_interzonal</span><span class="op">$</span><span class="va">Flow</span><span class="op">)</span> <span class="op">/</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">od_calculated_interzonal</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span>
<span class="va">od_calculated_interzonal</span> <span class="op">=</span> <span class="va">od_calculated_interzonal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>interaction_scaled <span class="op">=</span> <span class="va">interaction</span> <span class="op">*</span> <span class="va">scale_factor</span><span class="op">)</span>
<span class="va">od_joined</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span>
  <span class="va">od_calculated_interzonal</span>,
  <span class="va">od</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>O <span class="op">=</span> <span class="va">Orig_code</span>, D <span class="op">=</span> <span class="va">Dest_code</span><span class="op">)</span>
  <span class="op">)</span>
<span class="co">#&gt; Joining, by = c("O", "D")</span>
<span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Flow</span>, <span class="va">interaction_scaled</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="si_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_joined</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_joined</span><span class="op">$</span><span class="va">interaction_scaled</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>
<span class="co">#&gt; [1] 0.1677679</span></code></pre></div>
<p>The results show that a simple unconstrained model, without any parameter fitting, can explain less than 20% of the variability in flows. We can do better!</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">distance_euclidean</span><span class="op">^</span><span class="op">-</span><span class="fl">0.8</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">decay</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Flow</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">decay</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">Flow</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">decay</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> </code></pre></div>
<p><img src="si_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="a-production-constrained-sim">A production constrained SIM<a class="anchor" aria-label="anchor" href="#a-production-constrained-sim"></a>
</h2>
<p>The first logical way to improve model fit is to run a production constrained model. To do that, we’ll first calculate the total number of people leaving each zone and then use the <code>constraint_production</code> argument:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_originating</span> <span class="op">=</span> <span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">O</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>originating_per_zone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Flow</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_constrained_p</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_calculate.html">si_calculate</a></span><span class="op">(</span>
  <span class="va">od_originating</span>,
  fun <span class="op">=</span> <span class="va">si_power</span>,
  d <span class="op">=</span> <span class="va">distance_euclidean</span>,
  beta <span class="op">=</span> <span class="op">-</span><span class="fl">0.8</span>,
  constraint_production <span class="op">=</span> <span class="va">originating_per_zone</span>
  <span class="op">)</span>
<span class="va">od_constrained_p</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Flow</span>, <span class="va">interaction</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="si_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_constrained_p</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_constrained_p</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>
<span class="co">#&gt; [1] 0.3891644</span></code></pre></div>
<p>Progress! We have more than doubled the predictive ability of our model by using a ‘production constrained’ SIM, as defined mathematically in the <a href="https://robinlovelace.github.io/si/articles/sims-first-principles.html"><code>sim-first-principles</code> vignette</a>.</p>
</div>
<div class="section level2">
<h2 id="training-a-sim">Training a SIM<a class="anchor" aria-label="anchor" href="#training-a-sim"></a>
</h2>
<p>An advantage of the flow data used in this example is that we already know the interaction. (This raises the question of why a SIM is needed, answer: to test our models and demonstrate the techniques.)</p>
<p>We can do this using the <code><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls()</a></code> function as follows:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">minpack.lm</span><span class="op">)</span>
<span class="va">f</span> <span class="op">=</span> <span class="va">Flow</span> <span class="op">~</span> <span class="va">a</span> <span class="op">*</span> <span class="op">(</span><span class="va">distance_euclidean</span><span class="op">)</span><span class="op">^</span><span class="va">b</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html" class="external-link">nlsLM</a></span><span class="op">(</span>
  formula <span class="op">=</span> <span class="va">f</span>,
  data <span class="op">=</span> <span class="va">od_originating</span>,
  <span class="op">)</span>
<span class="co">#&gt; Warning in nlsLM(formula = f, data = od_originating, ): No starting values specified for some parameters.</span>
<span class="co">#&gt; Initializing 'a', 'b' to '1.'.</span>
<span class="co">#&gt; Consider specifying 'start' or using a selfStart model</span>
<span class="co">#&gt; Warning in nls.lm(par = start, fn = FCT, jac = jac, control = control, lower = lower, : lmdif: info = -1. Number of iterations has reached `maxiter' == 50.</span>
<span class="va">m</span>
<span class="co">#&gt; Nonlinear regression model</span>
<span class="co">#&gt;   model: Flow ~ a * (distance_euclidean)^b</span>
<span class="co">#&gt;    data: od_originating</span>
<span class="co">#&gt;          a          b </span>
<span class="co">#&gt;  2.182e+07 -5.801e-01 </span>
<span class="co">#&gt;  residual sum-of-squares: 3.089e+10</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of iterations till stop: 50 </span>
<span class="co">#&gt; Achieved convergence tolerance: 1.49e-08</span>
<span class="co">#&gt; Reason stopped: Number of iterations has reached `maxiter' == 50.</span>
<span class="co"># Nonlinear regression model</span>
<span class="co">#   model: Flow ~ a * (distance_euclidean)^b</span>
<span class="co">#    data: od_originating</span>
<span class="co">#          a          b </span>
<span class="co">#  2.182e+07 -5.801e-01 </span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">distance_euclidean</span><span class="op">^</span><span class="op">-</span><span class="fl">5.801e-01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">decay</span> <span class="op">*</span> <span class="fl">2.182e+07</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">Flow</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">decay</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> </code></pre></div>
<p><img src="si_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_pred</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_predict.html">si_predict</a></span><span class="op">(</span><span class="va">od_originating</span>, model <span class="op">=</span> <span class="va">m</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_pred</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_pred</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>
<span class="co">#&gt; [1] 0.1746446</span>
<span class="va">od_pred_const</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_predict.html">si_predict</a></span><span class="op">(</span><span class="va">od_originating</span>, model <span class="op">=</span> <span class="va">m</span>,
  constraint_production <span class="op">=</span> <span class="va">originating_per_zone</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_pred_const</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_pred_const</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>
<span class="co">#&gt; [1] 0.338483</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-dennett_estimating_2012">
<p>Dennett, Adam. 2012. “Estimating Flows Between Geographical Locations:’Get Me Started in’spatial Interaction Modelling.” <em>UCL Working Papers Series</em> 44 (0): 024. <a href="http://www.bartlett.ucl.ac.uk/casa/publications/working-paper-181" class="external-link">http://www.bartlett.ucl.ac.uk/casa/publications/working-paper-181</a>.</p>
</div>
<div id="ref-dennett_modelling_2018">
<p>———. 2018. “Modelling Population Flows Using Spatial Interaction Models.” <em>Australian Population Studies</em> 2 (2): 33–58. <a href="https://doi.org/10.37970/aps.v2i2.38" class="external-link">https://doi.org/10.37970/aps.v2i2.38</a>.</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Robin Lovelace, Jakub Nowosad.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
