---
title: "Validation of spatial interaction models"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(si)
library(sf)
library(od)
library(tmap)
library(dplyr)
library(ggplot2)
```

# Validation of 2011 OD data for Leeds, UK

The input datasets for this example are as follows:

- Geographic boundary and centroid data from the [{pct}](https://itsleeds.github.io/pct/) package, trip representing origins and destinations
- Origin-destination data representing trips to work from the 2011 Census
- Explanatory variables associated with zones, tbc

The key input datasets are shown below

```{r}
si_od_census
plot(si_zones$geometry)
plot(si_centroids$geometry, add = TRUE)
```

```{r}
od_from_si = si_to_od(origins = si_centroids, destinations = si_centroids)
nrow(si_od_census) / nrow(od_from_si)
```

The output shows that more than 90% of all possible combinations of OD pairs going from and to every zone are present in the validation dataset.
The maximum number of unique OD pairs for a given OD dataset is the number of origins multiplied by the number of destinations.
In this case that is `r nrow(si_zones)` * `r nrow(si_zones)` which is `r nrow(si_zones)^2` 
Before proceeding it's worth doing some sanity checks to find out:

- What does the spatial distribution of travel to work in Leeds look like?
- Which OD pairs that are 

```{r}
si_od_census_sf = si_od_census %>% 
  od_to_sf(si_centroids) %>%
  mutate(all, `Percent active` = (bicycle + foot) / all * 100)

si_od_census_sf %>%
  arrange(`Percent active`) %>% 
  tm_shape() +
  tm_lines(col = "Percent active", lwd = "all", scale = 3, palette = "viridis",
           breaks = c(0, 0.1, 0.2, 0.4, 1) * 100, legend.lwd.show = FALSE) +
  tm_scale_bar()
```

The figure above clearly shows that Leeds is a monocentric city with relatively high levels of active travel near the centre but with low levels of active travel in the outskirts.
From that we can predict the ~8% of OD pairs that *are not* in the dataset: long distance OD pairs avoiding the centre.
Let's find out:

```{r}
od_pairs_with_no_travel = od_from_si %>% 
  filter(!paste(O, D) %in% paste(si_od_census$O, si_od_census$D))
summary(od_pairs_with_no_travel$distance_euclidean)
summary(sf::st_length(si_od_census_sf))
```

As expected, the mean length of OD pairs in the observed Census is substantially less, and that's before calculating the weighted mean, which is just over 5 km:

```{r}
weighted.mean(sf::st_length(si_od_census_sf), w = si_od_census_sf$all)
```

In any case, let's proceed to some estimates of travel.

The very simplest model we could imagine to simulate movement between zones in the city, given knowledge of how many people travel to work between and within the zones of Leeds in total (`r round(sum(si_od_census$all) / 1000)`k), is to divide that movement equally between each OD pair.
In that case we would have:

```{r}
od_from_si$flow_equal = sum(si_od_census$all) / nrow(od_from_si)
```

Plotting this against the observed number of trips from the census data shows that, as we would expect, there is no correlation between this simplistic non-model and reality:

```{r}
od_joined = left_join(od_from_si, si_od_census)
od_joined %>% 
  ggplot(aes(all, flow_equal)) +
  geom_point()
```

So, how can we do better?
Although the classic gravity model is often presented as the most type, we can actually go a step simpler than that, using linear and exponential decay to approximate travel, without any attention paid to the population in each zone or any other factor.

# Valitation based on 2011 OA-WPZ data
